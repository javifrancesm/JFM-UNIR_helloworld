pipeline {
	agent any

	options { skipDefaultCheckout() }

	stages {

		stage('Get Code') {
			steps {
				git 'https://github.com/javifrancesm/JFM-UNIR_helloworld.git'
				echo WORKSPACE
				bat 'dir'
				stash name:'code', includes:'**'
				deleteDir()
			}
		}
			
				stage('Unit') {
					steps {
						catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
							unstash name:'code'
							bat '''
								set PYTHONPATH=%WORKSPACE%
								pytest --junitxml=result-unit.xml test\\unit
							'''
							junit 'result-unit.xml'
							deleteDir()
						}
					}
				}

				stage('Static&Security') {
				parallel {

					stage('Static') {
						steps {
							unstash name:'code'
							bat 'flake8 --exit-zero --format=pylint app >flake8.out'
							recordIssues tools: [flake8(name: 'Flake8', pattern: 'flake8.out')], qualityGates: [[threshold: 8, type: 'TOTAL', unstable: true], [threshold: 10, type: 'TOTAL', fail: true]]
							deleteDir()
						}
					}

/*					stage('Security') {
						steps {
							catchError(buildResult: '', stageResult: '') {
								unstash name:'code'

								junit 'result-'
								deleteDir()
							}
						}
					}	*/
				}
				}

				stage('Rest') {
					agent {label 'linux'}
					steps {
						catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
							unstash name:'code'
							sh '''
								export FLASK_APP=app/api.py
								cd "/home/Jenkins-Agent/workspace/JFM-UNIR/CP 1.2/CP 1.2 - Reto 1"
								flask run &
								sleep 5
								java -jar /home/wiremock-jre8-standalone-2.28.0.jar --port 9090 --root-dir "/home/Jenkins-Agent/workspace/JFM-UNIR/CP 1.2/CP 1.2 - Reto 1/test/wiremock" &
								export PYTHONPATH=${WORKSPACE}
								sleep 5
								cd "/home/Jenkins-Agent/workspace/JFM-UNIR/CP 1.2/CP 1.2 - Reto 1"
								pytest --junitxml=result-rest.xml test/rest
							'''
							junit 'result-rest.xml'
							deleteDir()
						}
					}
				}
/*
				stage('Performance') {
					steps {
						catchError(buildResult: '', stageResult: '') {
								unstash name:'code'

								junit 'result-'
								deleteDir()
						}
					}
				}

				stage('Coverage') {
					steps {
						catchError(buildResult: '', stageResult: '') {
								unstash name:'code'

								junit 'result-'
								deleteDir()
						}
					}
				}
*/
	}
}
