pipeline {
	agent any

	options { skipDefaultCheckout() }

	stages {

		stage('Get Code') {
			steps {
				git 'https://github.com/javifrancesm/JFM-UNIR_helloworld.git'
				echo WORKSPACE
				bat 'dir'
				stash name:'code', includes:'**'
				deleteDir()
			}
		}
			
				stage('Unit') {
					steps {
						catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
							unstash name:'code'
							bat '''
								set PYTHONPATH=%WORKSPACE%
								cd "C:\\Jenkins-Agent\\workspace\\JFM-UNIR-CP 1.2 - Reto 1"
								pytest --junitxml=result-unit.xml test\\unit
							'''
							junit 'result-unit.xml'
							deleteDir()
						}
					}
				}
/*
				stage('Rest') {
					steps {
						catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
							unstash name:'code'
							sh '''
								export FLASK_APP=app/api.py
								cd "/home/Jenkins-Agent/workspace/JFM-UNIR/CP 1.1/CP 1.1 - Reto 2"
								flask run &
								sleep 5
								java -jar /home/wiremock-jre8-standalone-2.28.0.jar --port 9090 --root-dir "/home/Jenkins-Agent/workspace/JFM-UNIR/CP 1.1/CP 1.1 - Reto 2/test/wiremock" &
								export PYTHONPATH=${WORKSPACE}
								sleep 10
								cd "/home/Jenkins-Agent/workspace/JFM-UNIR/CP 1.1/CP 1.1 - Reto 2"
								pytest --junitxml=result-rest.xml test/rest
							'''
							stash name:'rest-res', includes:'result-rest.xml'
							// stash name:'rest-res', includes:'**' -> Con solo 1 linux-agent es la forma de que no se "pisen".
							deleteDir()
						}
					}
				}
*/
	}
}
